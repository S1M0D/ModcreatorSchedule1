name: Release Beta

on:
  push:
    branches:
      - beta
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 1.0.0-beta.1). Leave empty to auto-increment from project file.'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: read

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Checkout Game Assemblies
      uses: actions/checkout@v4
      with:
        repository: ${{ secrets.GAME_ASSEMBLIES_REPO }}
        token: ${{ secrets.GAME_ASSEMBLIES_TOKEN }}
        path: game-assemblies
        fetch-depth: 1

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Create Assembly Directory Structure
      run: |
        New-Item -ItemType Directory -Force -Path "ModCreatorConnector\ScheduleOneAssemblies\Managed" | Out-Null
        New-Item -ItemType Directory -Force -Path "ModCreatorConnector\ScheduleOneAssemblies\MelonLoader" | Out-Null

    - name: Copy Game Assemblies
      run: |
        Write-Host "=== Copying Game Assemblies ==="
        if (Test-Path "game-assemblies\Managed") {
          Copy-Item -Path "game-assemblies\Managed\*" -Destination "ModCreatorConnector\ScheduleOneAssemblies\Managed\" -Recurse -Force
          Write-Host "✓ Copied Mono assemblies"
        } else {
          Write-Host "✗ No game-assemblies\Managed directory found"
        }
        if (Test-Path "game-assemblies\MelonLoader") {
          Copy-Item -Path "game-assemblies\MelonLoader\*" -Destination "ModCreatorConnector\ScheduleOneAssemblies\MelonLoader\" -Recurse -Force
          Write-Host "✓ Copied MelonLoader assemblies"
        } else {
          Write-Host "✗ No game-assemblies\MelonLoader directory found"
        }

    - name: Create CI Build Properties
      run: |
        $propsContent = @"
        <Project>
            <PropertyGroup>
                <!-- CI Assembly Paths (relative to ModCreatorConnector.csproj) -->
                <MelonLoaderAssembliesPath>./ScheduleOneAssemblies/MelonLoader</MelonLoaderAssembliesPath>
                <MonoAssembliesPath>./ScheduleOneAssemblies/Managed</MonoAssembliesPath>
            </PropertyGroup>
        </Project>
        "@
        $propsContent | Out-File -FilePath "ModCreatorConnector\ci.build.props" -Encoding UTF8

    - name: Build ModCreatorConnector (CI Configuration)
      working-directory: ModCreatorConnector
      run: dotnet build ModCreatorConnector.csproj -c CI

    - name: Extract and determine version
      id: get_version
      run: |
        # Get version from manual input or project file
        if ("${{ github.event.inputs.version }}" -ne "") {
          $baseVersion = "${{ github.event.inputs.version }}"
        } else {
          $baseVersion = Select-String -Path "Schedule1ModdingTool.csproj" -Pattern '<Version>(.*)</Version>' | ForEach-Object { $_.Matches.Groups[1].Value }
        }

        # Default if empty
        if ([string]::IsNullOrWhiteSpace($baseVersion)) {
          $baseVersion = "1.0.1"
        }

        # Strip any existing -beta suffix from .csproj (shouldn't be there, but just in case)
        $baseVersion = $baseVersion -replace '-beta.*$', ''

        # Create the beta release tag by appending -beta
        $betaTag = "${baseVersion}-beta"

        Write-Host "Base version: $baseVersion"
        Write-Host "Beta release tag: $betaTag"

        # BASE_VERSION = clean version (e.g., "1.0.1") - used for .csproj, AutoUpdater.xml, assembly version
        # BETA_TAG = version with -beta suffix (e.g., "1.0.1-beta") - used for GitHub release tag and filename
        echo "BASE_VERSION=$baseVersion" >> $env:GITHUB_ENV
        echo "BETA_TAG=$betaTag" >> $env:GITHUB_ENV
        echo "base_version=$baseVersion" >> $env:GITHUB_OUTPUT
        echo "beta_tag=$betaTag" >> $env:GITHUB_OUTPUT

    - name: Build Release
      run: dotnet build Schedule1ModdingTool.csproj -c Release -p:Version=$env:BASE_VERSION -p:CI=true

    - name: Publish Release
      run: dotnet publish Schedule1ModdingTool.csproj -c Release -p:Version=$env:BASE_VERSION -p:CI=true -o ./publish --self-contained false

    - name: Copy ModCreatorConnector DLL to publish directory
      run: |
        $connectorDll = "ModCreatorConnector\bin\CI\netstandard2.1\ModCreatorConnector.dll"
        $connectorDir = "publish\ModCreatorConnector"
        if (Test-Path $connectorDll) {
          New-Item -ItemType Directory -Force -Path $connectorDir | Out-Null
          Copy-Item -Path $connectorDll -Destination "$connectorDir\ModCreatorConnector.dll" -Force
          Write-Host "✓ Copied ModCreatorConnector DLL to publish directory"
        } else {
          Write-Host "✗ ModCreatorConnector DLL not found at: $connectorDll"
          exit 1
        }

    - name: Create release archive
      run: |
        # Use BETA_TAG for filename (e.g., "Schedule1ModdingTool-1.0.1-beta.zip")
        $archiveName = "Schedule1ModdingTool-$env:BETA_TAG.zip"
        Compress-Archive -Path "publish\*" -DestinationPath $archiveName -Force
        echo "ARCHIVE_NAME=$archiveName" >> $env:GITHUB_ENV

    - name: Update version files
      run: |
        # Update Schedule1ModdingTool.csproj with the BASE version (no -beta suffix)
        $csprojPath = "Schedule1ModdingTool.csproj"
        $csprojContent = Get-Content $csprojPath -Raw
        $csprojContent = $csprojContent -replace '<Version>.*?</Version>', "<Version>$env:BASE_VERSION</Version>"
        $csprojContent | Set-Content $csprojPath -NoNewline
        Write-Host "✓ Updated Schedule1ModdingTool.csproj with version $env:BASE_VERSION"

        # Update AutoUpdater.xml with BASE_VERSION (clean version for AutoUpdater.NET)
        # URL uses BETA_TAG for the GitHub release tag and filename
        $xmlLines = @(
            '<?xml version="1.0" encoding="UTF-8"?>',
            '<item>',
            "    <version>$env:BASE_VERSION</version>",
            "    <url>https://github.com/S1M0D/ModcreatorSchedule1/releases/download/v$env:BETA_TAG/Schedule1ModdingTool-$env:BETA_TAG.zip</url>",
            '    <changelog>https://github.com/S1M0D/ModcreatorSchedule1/releases/latest</changelog>',
            '    <mandatory>false</mandatory>',
            '</item>'
        )
        $xmlContent = $xmlLines -join "`n"
        $xmlContent | Out-File -FilePath "AutoUpdater.xml" -Encoding UTF8 -NoNewline
        Write-Host "✓ Updated AutoUpdater.xml:"
        Write-Host "   - Version: $env:BASE_VERSION (for comparison)"
        Write-Host "   - Download URL: v$env:BETA_TAG/Schedule1ModdingTool-$env:BETA_TAG.zip"

    - name: Commit and push version updates
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add Schedule1ModdingTool.csproj AutoUpdater.xml

        # Commit changes (ignore error if nothing to commit)
        try {
          git commit -m "chore: update version to $env:BASE_VERSION (beta release $env:BETA_TAG)"
          Write-Host "✓ Created commit"
        } catch {
          Write-Host "⚠ No changes to commit"
        }

        # Push to beta branch (ignore error if nothing to push)
        try {
          git push origin beta
          Write-Host "✓ Pushed to beta branch"
        } catch {
          Write-Host "⚠ Nothing to push"
        }

    - name: Generate release notes
      id: release_notes
      run: |
        $notes = "## Beta Release $env:BETA_TAG`n`n"
        $notes += "Automated beta release from beta branch.`n`n"
        $notes += "**Version:** ``$env:BASE_VERSION```n"
        $notes += "**Release Tag:** ``$env:BETA_TAG```n`n"
        $notes += "### Changes`n"
        $notes += "See commit history for details."
        echo "notes<<EOF" >> $env:GITHUB_OUTPUT
        echo "$notes" >> $env:GITHUB_OUTPUT
        echo "EOF" >> $env:GITHUB_OUTPUT

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ env.BETA_TAG }}
        name: Beta Release ${{ env.BETA_TAG }}
        body: ${{ steps.release_notes.outputs.notes }}
        prerelease: true
        files: ${{ env.ARCHIVE_NAME }}
        draft: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

